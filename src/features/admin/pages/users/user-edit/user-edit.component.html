<!-- Preloader -->
<app-preloader [show]="loading || loadingUser || isSubmitting" size="xl"></app-preloader>

<div class="flex items-center justify-center bg-base-200">
  <div class="card bg-base-100 shadow-xl max-w-4xl w-full">
    <!-- Header -->
    <div class="card-body">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="card-title text-2xl">Editar Usuario</h2>
          <p class="text-base-content/70 text-sm mt-2">Modifica la información del usuario seleccionado</p>
        </div>
        <button
          type="button"
          class="btn btn-ghost"
          (click)="onCancel()"
          [disabled]="loading || loadingUser || isSubmitting">
          Volver
        </button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="space-y-6">

        <!-- Información Personal -->
        <div class="space-y-6">
          <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-base-300">Información Personal</h3>

          <!-- Nombre y Apellido -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="floating-label">
                <span>Nombre *</span>
                <input
                  type="text"
                  class="input input-md w-full"
                  formControlName="firstName"
                  [class.input-error]="f['firstName'].invalid && f['firstName'].touched">
              </label>
              <div class="label" *ngIf="getFieldError('firstName')">
                <span class="label-text-alt text-error">{{ getFieldError('firstName') }}</span>
              </div>
            </div>

            <div class="form-control">
              <label class="floating-label">
                <span>Apellido *</span>
                <input
                  type="text"
                  class="input input-md w-full"
                  formControlName="lastName"
                  [class.input-error]="f['lastName'].invalid && f['lastName'].touched">
              </label>
              <div class="label" *ngIf="getFieldError('lastName')">
                <span class="label-text-alt text-error">{{ getFieldError('lastName') }}</span>
              </div>
            </div>
          </div>

          <!-- Email y Teléfono -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="floating-label">
                <span>Email *</span>
                <input
                  type="email"
                  class="input input-md w-full"
                  formControlName="email"
                  [class.input-error]="f['email'].invalid && f['email'].touched">
              </label>
              <div class="label" *ngIf="getFieldError('email')">
                <span class="label-text-alt text-error">{{ getFieldError('email') }}</span>
              </div>
            </div>

            <div class="form-control">
              <label class="floating-label">
                <span>Teléfono *</span>
                <input
                  type="tel"
                  class="input input-md w-full"
                  formControlName="phoneNumber"
                  [class.input-error]="f['phoneNumber'].invalid && f['phoneNumber'].touched">
              </label>
              <div class="label" *ngIf="getFieldError('phoneNumber')">
                <span class="label-text-alt text-error">{{ getFieldError('phoneNumber') }}</span>
              </div>
            </div>
          </div>

          <!-- URL de Foto de Perfil -->
          <div class="form-control">
            <label class="floating-label">
              <span>URL de Foto de Perfil</span>
              <input
                type="url"
                class="input input-md w-full"
                formControlName="profilePictureUrl"
                placeholder="URL de Foto de Perfil"
                [class.input-error]="f['profilePictureUrl'].invalid && f['profilePictureUrl'].touched">
            </label>
            <div class="label" *ngIf="getFieldError('profilePictureUrl')">
              <span class="label-text-alt text-error">{{ getFieldError('profilePictureUrl') }}</span>
            </div>
          </div>

          <!-- Vista previa de la foto -->
          <div class="form-control" *ngIf="f['profilePictureUrl'].value">
            <div class="flex justify-center">
              <div class="avatar">
                <div class="w-20 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                  <img [src]="f['profilePictureUrl'].value" [alt]="'Vista previa del avatar'"
                    (error)="f['profilePictureUrl'].setErrors({'invalidUrl': true})" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Configuración de Cuenta -->
        <div class="space-y-6">
          <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-base-300">Configuración de Cuenta</h3>

          <!-- Rol y Estado -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="floating-label">
                <span>Rol *</span>
                <select
                  class="select select-md w-full"
                  formControlName="role"
                  [class.select-error]="f['role'].invalid && f['role'].touched">
                  <option value="" disabled>Selecciona un rol</option>
                  <option *ngFor="let role of roles" [value]="role.value">
                    {{ role.label }}
                  </option>
                </select>
              </label>
              <div class="label" *ngIf="getFieldError('role')">
                <span class="label-text-alt text-error">{{ getFieldError('role') }}</span>
              </div>
            </div>

            <div class="form-control">
              <label class="floating-label">
                <span>Estado *</span>
                <select
                  class="select select-md w-full"
                  formControlName="isActive"
                  [class.select-error]="f['isActive'].invalid && f['isActive'].touched">
                  <option [value]="true">Activo</option>
                  <option [value]="false">Inactivo</option>
                </select>
              </label>
              <div class="label" *ngIf="getFieldError('isActive')">
                <span class="label-text-alt text-error">{{ getFieldError('isActive') }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex flex-col-reverse sm:flex-row justify-end gap-4 pt-6 border-t border-base-300">
          <button
            type="button"
            class="btn btn-ghost w-full sm:w-auto"
            (click)="onCancel()"
            [disabled]="loading || loadingUser || isSubmitting">
            Cancelar
          </button>

          <button
            type="submit"
            class="btn btn-primary w-full sm:w-auto"
            [disabled]="userForm.invalid || loading || loadingUser || isSubmitting">
            {{ isSubmitting ? 'Actualizando...' : 'Actualizar Usuario' }}
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
